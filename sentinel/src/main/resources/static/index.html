<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentinel Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); } 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } }
        .status-running { animation: pulse-green 2s infinite; }
        body { background: #0f172a; color: #f8fafc; font-family: 'Inter', sans-serif; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body class="p-8">

<div id="toast-container" class="fixed bottom-5 right-5 z-50"></div>

<div class="max-w-6xl mx-auto">
    <header class="flex justify-between items-center mb-12 border-b border-slate-700 pb-6">
        <div>
            <h1 class="text-4xl font-bold text-blue-400 tracking-tight">SENTINEL <span class="text-slate-500 text-lg font-mono">v1.0</span></h1>
            <p class="text-slate-400">Panel de Control de Resiliencia</p>
        </div>
        <div id="connection-status" class="px-4 py-1 rounded-full bg-red-900/30 text-red-400 border border-red-500/50 text-sm transition-all duration-500">
            Desconectado
        </div>
    </header>

    <div id="container-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    </div>
</div>

<script>
    let stompClient = null;

    function connect() {
        const socket = new SockJS('/sentinel-websocket');
        stompClient = Stomp.over(socket);
        stompClient.debug = null;

        stompClient.connect({}, function (frame) {
            updateStatusBadge(true);
            stompClient.subscribe('/topic/containers', function (message) {
                updateContainerCard(JSON.parse(message.body));
            });
        }, function(error) {
            updateStatusBadge(false);
            setTimeout(connect, 5000); // Reintento autom√°tico
        });
    }

    function updateStatusBadge(connected) {
        const el = document.getElementById('connection-status');
        if(connected) {
            el.innerText = 'En L√≠nea';
            el.className = "px-4 py-1 rounded-full bg-green-900/30 text-green-400 border border-green-500/50 text-sm";
        } else {
            el.innerText = 'Desconectado';
            el.className = "px-4 py-1 rounded-full bg-red-900/30 text-red-400 border border-red-500/50 text-sm";
        }
    }

    function apagarContenedor(id, nombre) {
        showToast(`Enviando se√±al de parada a ${nombre}...`, 'blue');
        fetch(`/api/containers/${id}/stop`, { method: 'POST' })
            .catch(err => showToast('Error al conectar con el API', 'red'));
    }

    function showToast(message, color) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `mb-3 px-6 py-3 rounded-lg glass border-${color}-500/50 text-${color}-400 shadow-xl border animate-bounce`;
        toast.innerText = message;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }

    function updateContainerCard(container) {
        const grid = document.getElementById('container-grid');
        let card = document.getElementById(`card-${container.id}`);

        if (!card) {
            card = document.createElement('div');
            card.id = `card-${container.id}`;
            grid.appendChild(card);
        }

        const isRunning = container.estado === 'running';
        const statusColor = isRunning ? 'text-green-400' : 'text-red-400';
        const bgColor = isRunning ? 'border-green-500/30' : 'border-red-500/30';
        const pulseClass = isRunning ? 'status-running' : '';
        const nombreLimpio = container.nombre.replace('/', '');

        // Detectar si Sentinel acaba de revivirlo (si el estado cambia de exited a running)
        const oldState = card.getAttribute('data-state');
        if (oldState === 'exited' && isRunning) {
            showToast(`üöÄ Sentinel ha recuperado ${nombreLimpio}`, 'green');
        }
        card.setAttribute('data-state', container.estado);

        card.className = `p-6 rounded-xl border ${bgColor} glass transition-all duration-500 hover:scale-[1.02]`;
        card.innerHTML = `
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-xl font-semibold truncate w-40">${nombreLimpio}</h3>
                <span class="h-3 w-3 rounded-full ${isRunning ? 'bg-green-500' : 'bg-red-500'} ${pulseClass}"></span>
            </div>
            <p class="text-sm text-slate-500 font-mono mb-6">ID: ${container.id.substring(0, 12)}</p>

            <div class="flex items-center justify-between">
                <span class="text-xs uppercase tracking-widest font-black ${statusColor}">${container.estado}</span>
                ${isRunning ? `
                    <button onclick="apagarContenedor('${container.id}', '${nombreLimpio}')"
                            class="text-xs bg-red-500/10 hover:bg-red-500/20 text-red-500 border border-red-500/50 px-3 py-1 rounded transition-colors">
                        FORZAR CA√çDA
                    </button>
                ` : '<span class="text-xs text-slate-500 italic">Reiniciando...</span>'}
            </div>
        `;
    }

    connect();
</script>
</body>
</html>