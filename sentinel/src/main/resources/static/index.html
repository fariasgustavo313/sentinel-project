<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentinel Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); } 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }
        .status-running { animation: pulse-green 2s infinite; }
        .status-blocked { animation: pulse-red 1.5s infinite; }
        body { background: #0f172a; color: #f8fafc; font-family: 'Inter', sans-serif; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .card-manual { opacity: 0.8; border-style: dashed; }
        .card-blocked { border-color: #ef4444 !important; background: rgba(127, 29, 29, 0.2); }
    </style>
</head>
<body class="p-8">
<div id="toast-container" class="fixed bottom-5 right-5 z-50"></div>

<div class="max-w-6xl mx-auto">
    <header class="flex justify-between items-center mb-12 border-b border-slate-700 pb-6">
        <div>
            <h1 class="text-4xl font-bold text-blue-400 tracking-tight">SENTINEL <span class="text-slate-500 text-lg font-mono">v1.2</span></h1>
            <p class="text-slate-400">Panel de Resiliencia y Monitoreo de Recursos</p>
        </div>
        <div id="connection-status" class="px-4 py-1 rounded-full bg-red-900/30 text-red-400 border border-red-500/50 text-sm">Desconectado</div>
    </header>

    <div id="container-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

    <div class="mt-16">
        <h2 class="text-2xl font-bold text-slate-400 mb-6 flex items-center">
            <span class="mr-3">üìã</span> Historial de Incidentes Recientes
        </h2>
        <div id="event-log" class="glass rounded-2xl overflow-hidden border border-slate-700">
            <div class="p-4 bg-slate-800/50 border-b border-slate-700 grid grid-cols-4 text-xs font-black uppercase tracking-widest text-slate-500">
                <div>Timestamp</div>
                <div>Contenedor</div>
                <div>Evento</div>
                <div>Detalle</div>
            </div>
            <div id="event-rows" class="divide-y divide-slate-800">
                <div class="p-4 text-center text-slate-500 italic text-sm">Esperando registros...</div>
            </div>
        </div>
    </div>
</div>

<script>
    let stompClient = null;

    function connect() {
        const socket = new SockJS('/sentinel-websocket');
        stompClient = Stomp.over(socket);
        stompClient.debug = null;
        stompClient.connect({}, () => {
            updateStatusBadge(true);
            stompClient.subscribe('/topic/containers', (msg) => updateContainerCard(JSON.parse(msg.body)));
        }, () => {
            updateStatusBadge(false);
            setTimeout(connect, 5000);
        });
    }

    function updateStatusBadge(connected) {
        const el = document.getElementById('connection-status');
        el.innerText = connected ? 'En L√≠nea' : 'Desconectado';
        el.className = connected ? "px-4 py-1 rounded-full bg-green-900/30 text-green-400 border border-green-500/50 text-sm"
                                 : "px-4 py-1 rounded-full bg-red-900/30 text-red-400 border border-red-500/50 text-sm";
    }

    function updateContainerCard(container) {
        const grid = document.getElementById('container-grid');
        let card = document.getElementById(`card-${container.id}`);

        if (!card) {
            card = document.createElement('div');
            card.id = `card-${container.id}`;
            grid.appendChild(card);
        }

        const isRunning = container.estado === 'running';
        const isRestarting = container.estado === 'restarting';
        const isBlocked = container.blocked;

        // L√≥gica para alertas de consumo de RAM (Umbral: 500MB)
        const memUsageRaw = container.memUsage ? parseInt(container.memUsage.replace("MB", "")) : 0;
        const memClass = (isRunning && memUsageRaw > 500) ? "text-red-500 animate-pulse font-bold" : "text-purple-400";

        const pulseClass = isBlocked ? 'status-blocked' : (isRunning ? 'status-running' : '');
        const statusColor = isBlocked ? 'text-red-600' : (isRunning ? 'text-green-400' : (isRestarting ? 'text-yellow-400' : 'text-red-400'));

        let borderColor = isRunning ? 'border-green-500/30' : (container.protegido ? 'border-blue-500/30' : 'border-slate-500/30');
        if (isBlocked) borderColor = 'border-red-600';

        let accionHTML = '';
        if (isBlocked) {
            accionHTML = '<span class="text-[12px] text-red-500 font-black uppercase tracking-tighter">‚ö†Ô∏è Bloqueado por Seguridad</span>';
        } else if (isRunning) {
            accionHTML = `
                <button onclick="fetch('/api/containers/${container.id}/stop', {method:'POST'})"
                        class="text-[10px] bg-red-500/10 hover:bg-red-500/20 text-red-500 border border-red-500/50 px-2 py-1 rounded transition-colors uppercase font-bold">
                    Kill Service
                </button>`;
        } else {
            accionHTML = container.protegido ?
                '<span class="text-[14px] text-blue-400 animate-pulse font-mono italic">Sentinel recuperando...</span>' :
                '<span class="text-[14px] text-slate-500 font-mono italic">Requiere arreglo manual</span>';
        }

        const badgeProteccion = container.protegido ?
            '<span class="text-[10px] bg-blue-500/20 text-blue-400 px-2 py-1 rounded-md border border-blue-500/30 font-bold tracking-widest">SENTINEL ACTIVE</span>' :
            '<span class="text-[10px] bg-slate-700/50 text-slate-400 px-2 py-1 rounded-md border border-slate-600 font-medium">MANUAL MODE</span>';

        card.className = `p-6 rounded-xl border ${borderColor} glass transition-all duration-500 ${!container.protegido ? 'card-manual' : 'hover:scale-[1.02]'} ${isBlocked ? 'card-blocked' : ''}`;

        // Definimos los valores de recursos (si no hay datos o el contenedor est√° parado, mostramos 0)
        const cpuVal = isRunning ? (container.cpuUsage || "0.00%") : "---";
        const memVal = isRunning ? (container.memUsage || "0MB") : "---";

        card.innerHTML = `
            <div class="flex justify-between items-start mb-2">
                <h3 class="text-xl font-semibold truncate w-40">${container.nombre}</h3>
                <span class="h-3 w-3 rounded-full ${isBlocked ? 'bg-red-600' : (isRunning ? 'bg-green-500' : (isRestarting ? 'bg-yellow-500' : 'bg-red-500'))} ${pulseClass}"></span>
            </div>
            <div class="mb-4">${badgeProteccion}</div>

            <div class="grid grid-cols-2 gap-2 mb-4">
                <div class="bg-black/40 border border-white/5 rounded-lg p-2 text-center">
                    <p class="text-[9px] text-slate-500 font-bold uppercase tracking-wider">CPU Usage</p>
                    <p class="text-sm font-mono font-black text-blue-400">${cpuVal}</p>
                </div>
                <div class="bg-black/40 border border-white/5 rounded-lg p-2 text-center">
                    <p class="text-[9px] text-slate-500 font-bold uppercase tracking-wider">Memory</p>
                    <p class="text-sm font-mono font-black ${memClass}">${memVal}</p>
                </div>
            </div>

            <div class="bg-black/20 border border-white/5 rounded-md p-2 mb-6">
                <p class="text-[10px] text-slate-500 font-mono italic tracking-tight uppercase opacity-60 mb-1">Instance Identifier</p>
                <p class="text-xs text-slate-300 font-mono truncate">${container.id.substring(0, 16)}</p>
            </div>

            <div class="flex items-center justify-between border-t border-white/5 pt-4">
                <span class="text-lg uppercase tracking-wider font-black ${statusColor} italic">
                    ${isBlocked ? 'CRITICAL_FAIL' : container.estado}
                </span>
                ${accionHTML}
            </div>
        `;
    }

    async function loadRecentEvents() {
        try {
            const response = await fetch('/api/events/recent');
            if (!response.ok) return;
            const events = await response.json();
            const container = document.getElementById('event-rows');

            if (events.length === 0) return;

            container.innerHTML = events.map(ev => {
                const date = new Date(ev.timestamp).toLocaleString();
                const colorClass = ev.eventType === 'FAILURE' ? 'text-red-400' :
                                   ev.eventType === 'RECOVERY' ? 'text-green-400' :
                                   ev.eventType === 'CRITICAL_ERROR' ? 'text-yellow-500' : 'text-blue-400';

                return `
                    <div class="grid grid-cols-4 p-4 text-sm font-mono items-center hover:bg-white/5 transition-colors">
                        <div class="text-slate-500 text-[11px]">${date}</div>
                        <div class="font-bold text-white uppercase truncate pr-2">${ev.containerName}</div>
                        <div class="${colorClass} font-black text-[10px] tracking-widest">${ev.eventType}</div>
                        <div class="text-slate-400 text-xs italic truncate">${ev.details}</div>
                    </div>
                `;
            }).join('');
        } catch (error) {
            console.error("Error cargando eventos:", error);
        }
    }

    setInterval(loadRecentEvents, 10000);
    loadRecentEvents();
    connect();
</script>
</body>
</html>